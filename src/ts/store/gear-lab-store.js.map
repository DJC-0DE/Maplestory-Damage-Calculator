{
  "version": 3,
  "sources": ["gear-lab-store.ts"],
  "sourcesContent": ["/**\r\n * Centralized store for Gear Lab data\r\n * Handles loading, saving, and migrating inner ability preset configuration\r\n *\r\n * DATA FLOW:\r\n * 1. User changes preset input\r\n * 2. Event listener fires UI handler\r\n * 3. UI handler calls gearLabStore.updatePreset()\r\n * 4. Store updates memory + saves to localStorage (immediate write)\r\n */\r\n\r\nimport type {\r\n    GearLabData,\r\n    InnerAbilityPreset,\r\n    InnerAbilityLine,\r\n    LegacyHeroPowerPresets\r\n} from '@ts/types/page/gear-lab/gear-lab.types';\r\nimport { DEFAULT_GEAR_LAB_DATA } from '@ts/types/page/gear-lab/gear-lab.types';\r\n\r\nexport class GearLabStore {\r\n    private data: GearLabData;\r\n    private isInitialized: boolean = false;\r\n\r\n    // ========================================================================\r\n    // CONSTRUCTOR\r\n    // ========================================================================\r\n\r\n    constructor() {\r\n        // Initialize with default data - will be populated by initialize()\r\n        this.data = JSON.parse(JSON.stringify(DEFAULT_GEAR_LAB_DATA));\r\n    }\r\n\r\n    // ========================================================================\r\n    // INITIALIZATION\r\n    // ========================================================================\r\n\r\n    /**\r\n     * Initialize store - loads from localStorage, handles migration\r\n     * Call this at the top of the application initialization\r\n     *\r\n     * @returns Promise that resolves when initialization is complete\r\n     */\r\n    async initialize(): Promise<void> {\r\n        if (this.isInitialized) {\r\n            console.warn('GearLabStore already initialized');\r\n            return;\r\n        }\r\n\r\n        // 1. Try loading from new 'gear-lab-data' key\r\n        const newData = localStorage.getItem('gear-lab-data');\r\n\r\n        if (newData) {\r\n            try {\r\n                this.data = JSON.parse(newData);\r\n                console.log('GearLabStore: Loaded from new format (gear-lab-data)');\r\n            } catch (e) {\r\n                console.error('GearLabStore: Failed to parse gear-lab-data, falling back to migration', e);\r\n                this.migrateFromLegacy();\r\n            }\r\n        } else {\r\n            // 2. If new key doesn't exist, migrate from old 'heroPowerPresets' key\r\n            this.migrateFromLegacy();\r\n        }\r\n\r\n        // 3. Validate and fill in missing fields with defaults\r\n        this.validateAndFillDefaults();\r\n\r\n        this.isInitialized = true;\r\n        console.log('GearLabStore: Initialization complete', this.data);\r\n    }\r\n\r\n    /**\r\n     * Migrate data from legacy 'heroPowerPresets' localStorage key to new format\r\n     */\r\n    private migrateFromLegacy(): void {\r\n        console.log('GearLabStore: Migrating from legacy format...');\r\n\r\n        const legacyDataStr = localStorage.getItem('heroPowerPresets');\r\n\r\n        if (!legacyDataStr) {\r\n            console.log('GearLabStore: No legacy heroPowerPresets found, using defaults');\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const legacy: LegacyHeroPowerPresets = JSON.parse(legacyDataStr);\r\n\r\n            // Migrate each preset\r\n            Object.entries(legacy).forEach(([key, preset]) => {\r\n                const presetId = parseInt(key);\r\n                if (presetId >= 1 && presetId <= 10) {\r\n                    this.data.innerAbility.presets[presetId] = {\r\n                        id: presetId,\r\n                        isEquipped: preset.isEquipped || false,\r\n                        lines: preset.lines || []\r\n                    };\r\n                }\r\n            });\r\n\r\n            console.log('GearLabStore: Migration complete, saving to new format...');\r\n            this.saveDualWrite();\r\n\r\n            // Clean up old localStorage key after successful migration\r\n            console.log('GearLabStore: Cleaning up old localStorage key...');\r\n            localStorage.removeItem('heroPowerPresets');\r\n            console.log('GearLabStore: Deleted heroPowerPresets key');\r\n        } catch (error) {\r\n            console.error('GearLabStore: Failed to migrate heroPowerPresets:', error);\r\n            // Don't delete old key if migration failed\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Validate data structure and fill missing fields with defaults\r\n     */\r\n    private validateAndFillDefaults(): void {\r\n        const defaults = DEFAULT_GEAR_LAB_DATA;\r\n\r\n        // Ensure innerAbility.presets exists and has all 10 presets\r\n        if (!this.data.innerAbility?.presets) {\r\n            this.data.innerAbility = {\r\n                presets: { ...defaults.innerAbility.presets }\r\n            };\r\n        }\r\n\r\n        // Ensure all presets 1-10 exist\r\n        for (let i = 1; i <= 10; i++) {\r\n            if (!this.data.innerAbility.presets[i]) {\r\n                this.data.innerAbility.presets[i] = {\r\n                    id: i,\r\n                    isEquipped: false,\r\n                    lines: []\r\n                };\r\n            } else {\r\n                // Validate preset structure\r\n                const preset = this.data.innerAbility.presets[i];\r\n                if (typeof preset.id !== 'number') preset.id = i;\r\n                if (typeof preset.isEquipped !== 'boolean') preset.isEquipped = false;\r\n                if (!Array.isArray(preset.lines)) preset.lines = [];\r\n            }\r\n        }\r\n\r\n        // Ensure only one preset is equipped\r\n        const equippedPresets = Object.values(this.data.innerAbility.presets)\r\n            .filter(p => p.isEquipped);\r\n\r\n        if (equippedPresets.length > 1) {\r\n            // Keep only the first equipped preset\r\n            equippedPresets.slice(1).forEach(p => p.isEquipped = false);\r\n            console.warn('GearLabStore: Multiple presets equipped, keeping only first');\r\n        }\r\n    }\r\n\r\n    // ========================================================================\r\n    // GETTERS - Return pre-hydrated data with safe defaults\r\n    // ========================================================================\r\n\r\n    /**\r\n     * Get all inner ability presets\r\n     * @returns All 10 presets as a record\r\n     */\r\n    getInnerAbilityPresets(): Record<number, InnerAbilityPreset> {\r\n        return JSON.parse(JSON.stringify(this.data.innerAbility.presets));\r\n    }\r\n\r\n    /**\r\n     * Get a single preset\r\n     * @param id - Preset ID (1-10)\r\n     * @returns Preset data or null if not found\r\n     */\r\n    getPreset(id: number): InnerAbilityPreset | null {\r\n        const preset = this.data.innerAbility.presets[id];\r\n        return preset ? JSON.parse(JSON.stringify(preset)) : null;\r\n    }\r\n\r\n    /**\r\n     * Get the currently equipped preset ID\r\n     * @returns Equipped preset ID (1-10) or null if none equipped\r\n     */\r\n    getEquippedPresetId(): number | null {\r\n        const equipped = Object.values(this.data.innerAbility.presets)\r\n            .find(p => p.isEquipped);\r\n        return equipped ? equipped.id : null;\r\n    }\r\n\r\n    /**\r\n     * Get all data (for export/debugging)\r\n     * @returns Deep clone of gear lab data\r\n     */\r\n    getAllData(): GearLabData {\r\n        return JSON.parse(JSON.stringify(this.data));\r\n    }\r\n\r\n    // ========================================================================\r\n    // SETTERS - Partial updates with immediate save\r\n    // ========================================================================\r\n\r\n    /**\r\n     * Update a preset\r\n     * @param id - Preset ID (1-10)\r\n     * @param data - Partial preset data to update\r\n     */\r\n    updatePreset(id: number, data: Partial<InnerAbilityPreset>): void {\r\n        if (id < 1 || id > 10) {\r\n            console.error(`GearLabStore: Invalid preset ID ${id}`);\r\n            return;\r\n        }\r\n\r\n        if (!this.data.innerAbility.presets[id]) {\r\n            this.data.innerAbility.presets[id] = {\r\n                id,\r\n                isEquipped: false,\r\n                lines: []\r\n            };\r\n        }\r\n\r\n        // Merge update with existing preset\r\n        this.data.innerAbility.presets[id] = {\r\n            ...this.data.innerAbility.presets[id],\r\n            ...data,\r\n            id  // Ensure id cannot be changed\r\n        };\r\n\r\n        // Ensure only one preset is equipped\r\n        if (data.isEquipped === true) {\r\n            for (let i = 1; i <= 10; i++) {\r\n                if (i !== id) {\r\n                    this.data.innerAbility.presets[i].isEquipped = false;\r\n                }\r\n            }\r\n        }\r\n\r\n        this.saveDualWrite();\r\n    }\r\n\r\n    /**\r\n     * Update a single line in a preset\r\n     * @param presetId - Preset ID (1-10)\r\n     * @param lineIndex - Line index (0-5)\r\n     * @param line - Line data\r\n     */\r\n    updatePresetLine(presetId: number, lineIndex: number, line: InnerAbilityLine): void {\r\n        if (presetId < 1 || presetId > 10) {\r\n            console.error(`GearLabStore: Invalid preset ID ${presetId}`);\r\n            return;\r\n        }\r\n\r\n        if (lineIndex < 0 || lineIndex > 5) {\r\n            console.error(`GearLabStore: Invalid line index ${lineIndex}`);\r\n            return;\r\n        }\r\n\r\n        const preset = this.data.innerAbility.presets[presetId];\r\n        if (!preset) {\r\n            console.error(`GearLabStore: Preset ${presetId} not found`);\r\n            return;\r\n        }\r\n\r\n        // Ensure lines array exists and has enough space\r\n        if (!preset.lines) {\r\n            preset.lines = [];\r\n        }\r\n\r\n        // Extend array if needed\r\n        while (preset.lines.length <= lineIndex) {\r\n            preset.lines.push({ stat: '', value: 0 });\r\n        }\r\n\r\n        preset.lines[lineIndex] = line;\r\n        this.saveDualWrite();\r\n    }\r\n\r\n    /**\r\n     * Set which preset is equipped\r\n     * @param id - Preset ID to equip (1-10), or null to unequip all\r\n     */\r\n    setEquippedPreset(id: number | null): void {\r\n        if (id !== null && (id < 1 || id > 10)) {\r\n            console.error(`GearLabStore: Invalid preset ID ${id}`);\r\n            return;\r\n        }\r\n\r\n        // Unequip all presets\r\n        for (let i = 1; i <= 10; i++) {\r\n            this.data.innerAbility.presets[i].isEquipped = false;\r\n        }\r\n\r\n        // Equip the specified preset\r\n        if (id !== null) {\r\n            this.data.innerAbility.presets[id].isEquipped = true;\r\n        }\r\n\r\n        this.saveDualWrite();\r\n    }\r\n\r\n    // ========================================================================\r\n    // PERSISTENCE\r\n    // ========================================================================\r\n\r\n    /**\r\n     * Save to localStorage\r\n     */\r\n    private saveDualWrite(): void {\r\n        localStorage.setItem('gear-lab-data', JSON.stringify(this.data));\r\n    }\r\n\r\n    // ========================================================================\r\n    // TESTING/DEBUGGING HELPERS\r\n    // ========================================================================\r\n\r\n    /**\r\n     * Reset store to defaults (for testing)\r\n     */\r\n    reset(): void {\r\n        this.data = JSON.parse(JSON.stringify(DEFAULT_GEAR_LAB_DATA));\r\n        this.saveDualWrite();\r\n    }\r\n\r\n    /**\r\n     * Check if store is initialized\r\n     */\r\n    isReady(): boolean {\r\n        return this.isInitialized;\r\n    }\r\n}\r\n\r\n// ========================================================================\r\n// SINGLETON EXPORT\r\n// ========================================================================\r\n\r\nexport const gearLabStore = new GearLabStore();\r\n"],
  "mappings": "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",
  "names": []
}
